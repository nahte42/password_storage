#include<iostream>
#include<string>
#include<fstream>
#include<cstdlib>
//#include<curses.h>

using namespace std;


string hash_pwd(string user, string pass);
void login();
void create();

int main(){

  
  int ui;
  while(1){
    cout<<"Select from the list:\n1) Login\n2) Create New User\n3) Exit\n";
    cin>>ui;
    if(ui == 1)
      login();
    else if(ui == 2)
      create();
    else if(ui == 3)
      exit(0);
    else
      cout<<"Please enter a number from 1 to 3\n";
    cout<<endl;
  }
  return 0;
}

void login(){
  bool found = false;
  string check;
  string un = "users.txt";
  string pn = "passwordfile.txt";
  int pos;
  int lgth;
  string username;
  string password;
  fstream usrFile;
  fstream pasFile;
  usrFile.open(un.c_str(), ios::in);
  pasFile.open(pn.c_str(), ios::in);

  while(!found){
    cout<<"user: ";
    cin>>username;
    cout<<"password: ";
    char ch = cin.get();
    while(ch != '\r'){
      password.push_back(ch);
      cout<<"*";
      ch = cin.get();
    }
    while(usrFile >> check){
      if(check == username){
	found = true;
	usrFile >> pos;
	usrFile >> lgth;
	break;
      }
      else{
	usrFile >> check;
	usrFile >> check;
      }
    }
    if(!found){
      cout<<"Username or password was incorrect: \n";
      return;
    }
    char * pwrd = new char[lgth];
    if(password.length() != lgth){
      cout<<"Username or password was incorrect: \n";
      return;
    }
    else{
      pasFile.seekp(pos);
      pasFile.read(pwrd,lgth);
      password = hash_pwd(username, password);
      for(int i = 0; i < lgth; i ++){
	if(password[i] != pwrd[i]){
	  cout<<"Username or password was incorrect: \n";
	  return;
	}
      }
    }
  }
  cout<<"Welcome "<<username<<"!"<<endl;
}

void create(){
  //Files
  bool taken = true;
  string check;
  string un = "users.txt";
  string pn = "passwordfile.txt";
  string username;
  string password;
  fstream usrFile;
  fstream pasFile;
  usrFile.open(un.c_str(),ios::in|ios::out);
  pasFile.open(pn.c_str(),ios::in);
  if(usrFile.fail())
    cout<<1<<endl;

  while(taken){
    taken = false;
    cout << "Please Create A Username: ";
    cin >> username;
    while(usrFile >> check){
      if(username == check){
	taken = true;
	cout<<"Sorry But That Username is Already Taken\n";
      }
      else{
	usrFile >> check;
	usrFile >> check;
      }
    }
    usrFile.close();
    usrFile.open(un.c_str(),ios::in|ios::out);
  }
  usrFile.close();
  usrFile.open(un.c_str(),ios::app);
  taken = true;
  /*  usrFile << username;
      usrFile<<" "<<40<<" "<<9<<endl;*/

  while(taken){
    taken = false;
    cout<<"Please entert a password with 8 or more characters: ";
    cin >> password;
    if(password.length() < 8){
      taken = true;
      cout<<"That password is less than 8 characters\n";
    }
  }
  password = (hash_pwd(username,password));

  
  int pos;
  int lgth;
  string allPass;
  pasFile >> allPass;
  pasFile.close();
  pasFile.open(pn.c_str(),ios::app);
  pos = allPass.length();
  lgth = password.length();
  pasFile<<password;
  usrFile<<username<<" "<<pos<<" "<<lgth<<endl;
  pasFile.close();
  usrFile.close();
  
}

string hash_pwd(string user, string pass){
  for(int i = 0; i < pass.length(); i++){
    int val = int(pass[i]);
    val *= val;
    val++;
    val+=val/2;
    val = (val%95)+33;
    pass[i] = char(val);
  }
  return pass;
}
